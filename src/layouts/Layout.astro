---
import Sidebar from '../components/Sidebar.astro';
import Header from '../components/Header.astro';

import '../styles/global.css'; 

interface Props {
	title: string;
}
const { title = "PortfÃ³lio" } = Astro.props;
---

<!doctype html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

		<title>{title}</title>

    

	</head>
  <body>
    <Header />
    <div class="app-shell">
      <div class="card-slot" aria-hidden="true"></div>
      <Sidebar />
      <main class="content">
        <slot />
      </main>
    </div>
    <footer class="site-footer">
      <div class="footer-row">
        <span data-i18n-key="footer.made">feito com â¤ï¸ por Davi</span>
        <div class="lang-toggle" aria-label="Language">
          <button type="button" class="lang-btn" data-set-lang="pt-BR" aria-label="PortuguÃªs (Brasil)">ğŸ‡§ğŸ‡· PT-BR</button>
          <button type="button" class="lang-btn" data-set-lang="en-US" aria-label="English (United States)">ğŸ‡ºğŸ‡¸ EN-US</button>
        </div>
      </div>
    </footer>

    <script>
      const translations = {
        'pt-BR': {
          'nav.home': 'InÃ­cio',
          'nav.blog': 'Blog',
          'nav.contact': 'Contato',
          'meta.base': 'Base',
          'meta.baseCity': 'JoÃ£o Pessoa, Brasil',
          'home.recent': 'Postagens recentes',
          'home.viewAll': 'Ver tudo',
          'footer.made': 'feito com â¤ï¸ por Davi',
          'title.home': 'InÃ­cio',
          'title.blog': 'Blog',
          'title.contact': 'Contato',
          'blog.header.kicker': 'Blog',
          'blog.header.title': 'Artigos e Postagens',
          'blog.header.lead': 'Nada daqui tem DOI nem qualis, mas Ã© digitado com o coraÃ§Ã£o e (quase) sem IA.',
          'blog.postedOn': 'Publicado em',
          'contact.title': 'Fale comigo',
          'contact.subtitle': 'Tem uma ideia, projeto ou dÃºvida? Envie uma mensagem.',
          'contact.nameLabel': 'Nome',
          'contact.emailLabel': 'Email',
          'contact.subjectLabel': 'Assunto',
          'contact.messageLabel': 'Mensagem',
          'contact.submit': 'Enviar',
          'contact.namePh': 'Seu nome',
          'contact.emailPh': 'voce@exemplo.com',
          'contact.subjectPh': 'Sobre o que Ã©?',
          'contact.messagePh': 'Escreva sua mensagem...',
          'contact.status.sending': 'Enviando...',
          'contact.status.success': 'Obrigado! Sua mensagem foi enviada com sucesso.',
          'contact.status.error': 'NÃ£o foi possÃ­vel enviar. Tente novamente mais tarde.',
          'contact.status.network': 'Erro de rede. Verifique sua conexÃ£o e tente novamente.'
        },
        'en-US': {
          'nav.home': 'Home',
          'nav.blog': 'Blog',
          'nav.contact': 'Contact',
          'meta.base': 'Base',
          'meta.baseCity': 'JoÃ£o Pessoa, Brazil',
          'home.recent': 'Recent posts',
          'home.viewAll': 'View all',
          'footer.made': 'made with â¤ï¸ by Davi',
          'title.home': 'Home',
          'title.blog': 'Blog',
          'title.contact': 'Contact',
          'blog.header.kicker': 'Blog',
          'blog.header.title': 'Articles and Posts',
          'blog.header.lead': 'None of this has a DOI or qualis, but it is typed with heart and (almost) no AI.',
          'blog.postedOn': 'Published on',
          'contact.title': 'Contact me',
          'contact.subtitle': 'Have an idea, project, or question? Send a message.',
          'contact.nameLabel': 'Name',
          'contact.emailLabel': 'Email',
          'contact.subjectLabel': 'Subject',
          'contact.messageLabel': 'Message',
          'contact.submit': 'Send',
          'contact.namePh': 'Your name',
          'contact.emailPh': 'you@example.com',
          'contact.subjectPh': 'What is it about?',
          'contact.messagePh': 'Write your message...',
          'contact.status.sending': 'Sending...',
          'contact.status.success': 'Thank you! Your message has been sent.',
          'contact.status.error': 'Could not send. Please try again later.',
          'contact.status.network': 'Network error. Check your connection and try again.'
        }
      };

      let currentLang = 'en-US';

      const formatDates = (lang) => {
        document.querySelectorAll('.date[data-date]').forEach((el) => {
          const iso = el.getAttribute('data-date');
          if (!iso) return;
          const date = new Date(iso);
          try {
            el.textContent = date.toLocaleDateString(lang);
          } catch {
            el.textContent = date.toLocaleDateString('en-US');
          }
        });
      };

      const setPageTitle = (lang) => {
        const dict = translations[lang] || translations['en-US'];
        const path = location.pathname;
        let pageName = '';
        if (path === '/' || path === '') {
          pageName = dict['title.home'] || 'Home';
        } else if (path === '/blog' || path === '/blog/') {
          pageName = dict['title.blog'] || 'Blog';
        } else if (path.startsWith('/blog/')) {
          const postTitleNode = document.querySelector('article.post-article h1');
          const postTitle = postTitleNode && postTitleNode.textContent ? postTitleNode.textContent.trim() : '';
          pageName = postTitle || (dict['title.blog'] || 'Blog');
        } else if (path.startsWith('/contato')) {
          pageName = dict['title.contact'] || 'Contact';
        } else {
          pageName = document.title.replace(/^.*\|\s*/, '') || 'Page';
        }
        document.title = `davi.cc | ${pageName}`;
      };

      const applyLanguage = (lang) => {
        const dict = translations[lang] || translations['en-US'];
        currentLang = lang;
        document.documentElement.setAttribute('lang', lang.startsWith('pt') ? 'pt-BR' : 'en');
        document.querySelectorAll('[data-i18n-key]').forEach((el) => {
          const key = el.getAttribute('data-i18n-key');
          if (key && dict[key]) el.textContent = dict[key];
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
          const key = el.getAttribute('data-i18n-placeholder');
          if (key && dict[key] && 'placeholder' in el) {
            el.placeholder = dict[key];
          }
        });
        formatDates(lang);
        setPageTitle(lang);
        localStorage.setItem('lang', lang);
        window.__i18n = {
          t: (key) => (translations[currentLang] && translations[currentLang][key]) || key,
          getLang: () => currentLang
        };
      };

      const initLang = async () => {
        const stored = localStorage.getItem('lang');
        if (stored && translations[stored]) {
          applyLanguage(stored);
          return;
        }
        let detected = null;
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 1200);
          const resp = await fetch('https://ipapi.co/json/', { signal: controller.signal });
          clearTimeout(timeout);
          if (resp.ok) {
            const data = await resp.json();
            detected = data && data.country_code === 'BR' ? 'pt-BR' : 'en-US';
          }
        } catch (_) {
          // ignore network errors, fallback to navigator
        }
        if (!detected) {
          detected = (navigator.language || 'en-US').startsWith('pt') ? 'pt-BR' : 'en-US';
        }
        applyLanguage(detected);
      };

      const initLangToggle = () => {
        document.querySelectorAll('.lang-btn[data-set-lang]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const lang = btn.getAttribute('data-set-lang') || 'en-US';
            applyLanguage(lang);
          });
        });
      };

      initLang();
      initLangToggle();
      document.addEventListener('astro:page-load', () => {
        initLangToggle();
        formatDates(currentLang);
        setPageTitle(currentLang);
      });
    </script>
 
    

        </body>
</html>
